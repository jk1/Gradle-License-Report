---
name: Publish
run-name: "ðŸš€ Publish ${{ inputs.tag_name }} (via ${{ github.ref_name }})"

on:
  workflow_call:
    inputs:
      tag_name:
        description: "branch, tag or SHA to publish"
        type: string
        default: ""
      validate_only:
        description: "Validation only (do not publish)"
        type: boolean
        default: true
    secrets:
      publish_key:
        description: Gradle Publish Plugin Key
        required: true
      publish_secret:
        description: Gradle Publish Plugin Secret
        required: true
      signing_key_id:
        description: Gradle Signing Key ID
        required: false
      signing_password:
        description: Gradle Signing Password
        required: false
      signing_key:
        description: Gradle Signing Key
        required: false

env:
  CI: "true"

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.tag_name }}

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: temurin
          check-latest: true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Publish Plugin to Gradle Portal
        env:
          GRADLE_PUBLISH_KEY: ${{ secrets.publish_key }}
          GRADLE_PUBLISH_SECRET: ${{ secrets.publish_secret }}
          ORG_GRADLE_PROJECT_signingKeyId: ${{ secrets.signing_key_id }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.signing_password }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.signing_key }}

        run: ./gradlew publishPlugins ${{ inputs.validate_only && '--validate-only' || '' }}
